# 前端文件查询逻辑修改说明

## 修改背景

由于文件命名格式从 `BV号_日期_AI早报.ext` 更改为 `日期_AI早报_BV号.ext`，需要同步修改前端应用的文件查询和解析逻辑。

## 修改内容

### 1. 文件名解析逻辑更新

#### 文件：`frontend/app.py`
#### 函数：`_parse_filename` (第32-52行)

**原逻辑**:
```python
# 文件名格式: BV号_日期_AI早报.md
match = re.match(r'([^_]+)_(\d{4}-\d{2}-\d{2})_AI早报\.md', filename)
```

**新逻辑**:
```python
# 文件名格式: 日期_AI早报_BV号.md (新格式)
match = re.match(r'(\d{4}-\d{2}-\d{2})_AI早报_([^\.]+)\.md', filename)
if match:
    return {
        'bv_id': match.group(2),  # BV号现在是第二组
        'date': match.group(1),   # 日期现在是第一组
        'filename': filename
    }

# 兼容旧格式: BV号_日期_AI早报.md
match_old = re.match(r'([^_]+)_(\d{4}-\d{2}-\d{2})_AI早报\.md', filename)
if match_old:
    return {
        'bv_id': match_old.group(1),
        'date': match_old.group(2),
        'filename': filename
    }
```

### 2. 兼容性设计

- **向前兼容**: 新的解析逻辑优先支持新格式
- **向后兼容**: 保留对旧格式文件的支持，确保现有文件仍可正常解析
- **渐进式迁移**: 新旧格式文件可以共存，系统正常工作

### 3. 正则表达式说明

**新格式正则**: `r'(\d{4}-\d{2}-\d{2})_AI早报_([^\.]+)\.md'`
- `(\d{4}-\d{2}-\d{2})`: 匹配日期格式 (2025-11-22)
- `_AI早报_`: 固定分隔符
- `([^\.]+)`: 匹配BV号，直到遇到点号
- `\.md`: 匹配文件扩展名

## 测试结果

### 1. API测试
```bash
curl http://localhost:5001/api/newspapers
```

✅ **成功解析新格式文件**:
- 文件名: `2025-11-22_AI早报_BV1a3UHBNENX.md`
- 提取BV号: `BV1a3UHBNENX`
- 提取日期: `2025-11-22`

### 2. 缓存刷新测试
```bash
curl http://localhost:5001/api/refresh
```

✅ **缓存刷新成功**:
- 总计识别: 13个文件
- 状态: `success: true`

### 3. 排序验证
✅ **按日期降序排列**: 最新日期的文件排在前面

## 技术细节

### 1. 正则表达式分组
- **新格式**: 日期是group(1)，BV号是group(2)
- **旧格式**: BV号是group(1)，日期是group(2)

### 2. 字段映射
新逻辑中`bv_id`和`date`字段的赋值顺序保持不变，确保前端其他部分无需修改。

### 3. 性能影响
- 增加了一个正则表达式匹配，但对性能影响极小
- 文件解析逻辑依然在缓存机制内，实际调用频率低

## 优势

1. **平滑迁移**: 新旧格式并存，系统无缝运行
2. **数据完整性**: 正确提取BV号和日期信息
3. **维护性**: 代码结构清晰，易于理解和维护
4. **扩展性**: 如需支持更多格式，可继续添加匹配逻辑

## 验证清单

- [x] 新格式文件正确解析
- [x] 旧格式文件兼容解析
- [x] API返回正确的数据结构
- [x] 文件排序功能正常
- [x] 缓存刷新功能正常
- [x] 前端服务启动正常

## 总结

前端文件查询逻辑修改成功完成，系统现在能够：
- 正确解析新格式文件名
- 保持对旧格式文件的兼容性
- 维持正常的API功能和数据结构
- 确保前端应用的稳定运行