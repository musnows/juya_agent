# Juya AI早报生成器 --history 功能说明

## 新增功能概述

新增了 `--history` 参数，支持批量处理历史指定天数的AI早报视频。

## 主要特性

### 1. 智能视频识别
- 自动识别指定日期范围内的AI早报视频
- 支持多种关键词匹配：AI、人工智能、早报、资讯、科技、技术
- 按日期筛选，确保处理指定时间范围内的视频

### 2. 批量处理能力
- 支持处理最近1-100天的历史数据
- 自动跳过已存在的文档（除非使用 `--force` 强制重新生成）
- 提供详细的处理进度和结果统计

### 3. 完整的报告机制
- 生成JSON格式的详细处理报告
- 包含成功、跳过、失败的统计信息
- 保存到 `docs/` 目录便于后续分析

## 使用方法

### 基本用法

```bash
# 处理最近30天的AI早报（默认）
python main.py --history

# 处理最近15天的AI早报
python main.py --history 15

# 处理最近60天的AI早报
python main.py --history 60
```

### 强制重新生成

```bash
# 强制重新生成最近30天的所有AI早报（覆盖已存在的文档）
python main.py --history --force
```

### 组合使用

```bash
# 处理历史早报并发送邮件报告
python main.py --history 30 --send-email
```

## 核心实现

### 新增方法

1. **`get_ai_reports_by_date_range(start_date, end_date)`**
   - 获取指定日期范围内的所有AI早报视频
   - 自动估算需要的视频数量，避免API限制
   - 按日期筛选并选择每天最新的视频

2. **`process_history_reports(days, force_regenerate)`**
   - 处理历史AI早报的核心方法
   - 支持跳过已存在文档的逻辑
   - 返回详细的处理结果统计

3. **`history_run(processor, days, force)`**
   - 历史运行模式的入口函数
   - 负责输出格式化的处理报告
   - 保存处理结果到JSON文件

### 优化改进

1. **`_is_ai_early_report()` 方法增强**
   - 新增 `target_date` 参数支持指定日期检查
   - 更灵活的日期匹配逻辑

2. **日期处理优化**
   - 导入 `timedelta` 支持日期计算
   - 精确的日期范围控制

## 输出文件

### 处理生成的文件
- **Markdown文件**: `docs/{BV号}_{日期}_AI早报.md`
- **JSON文件**: `docs/{BV号}_{日期}_AI早报.json`
- **处理报告**: `docs/history_report_{时间戳}.json`

### 报告格式示例

```json
{
  "total_found": 25,
  "total_processed": 18,
  "total_skipped": 7,
  "total_failed": 0,
  "date_range": {
    "start": "2024-11-22",
    "end": "2024-12-21"
  },
  "reports": [
    {
      "date": "2024-12-21",
      "bvid": "BV1234567890",
      "title": "【橘鸦AI早报】今日AI热点...",
      "status": "success",
      "reason": "处理成功"
    }
  ]
}
```

## 注意事项

1. **API限制**: B站API有调用频率限制，处理大量历史数据时需要考虑适当间隔
2. **存储空间**: 确保有足够的磁盘空间存储生成的文档
3. **网络稳定**: 处理过程需要稳定的网络连接访问B站API
4. **处理时间**: 处理30天历史数据通常需要10-20分钟，具体取决于视频数量和网络状况

## 错误处理

- 网络连接失败会重试3次
- 视频处理失败会记录错误信息并继续处理其他视频
- 所有异常都有详细的错误日志输出

## 性能优化建议

1. **首次处理**: 建议先处理少量天数（如7天）测试效果
2. **定期更新**: 可以配合定时任务每周处理新增的AI早报
3. **存储管理**: 定期清理过期的历史报告文件